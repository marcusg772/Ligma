<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Mary vs Marcus">
<link rel="apple-touch-icon" href="icon.png">
<title>Mary vs Marcus ‚Äî Multiplayer</title>
<style>
:root{--bg:#071028;--accent:#E6C07B;--muted:#95A1B3}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#071028;color:#E6EEF8;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:16px}
.container{max-width:720px;width:100%}
.header{display:flex;justify-content:space-between;align-items:center}
h1{font-size:18px;margin:0}
.panel{background:linear-gradient(180deg,#081427,#071022);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);margin-top:12px}
.input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;margin-bottom:8px}
.row{display:flex;gap:8px}
.btn{flex:1;padding:12px;border-radius:10px;border:none;background:var(--accent);color:#02101a;font-weight:800}
.small{font-size:13px;color:var(--muted)}
.center{text-align:center}
.log{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-top:10px;min-height:72px}
.playerLabel{font-weight:700;margin-bottom:6px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Mary vs Marcus ‚Äî Multiplayer</h1>
    <div class="small">Use a room code to play</div>
  </div>

  <div class="panel" id="lobby">
    <div class="small">Create a new room or join an existing one. Share the 6-digit room code with your friend.</div>
    <input id="nameInput" class="input" placeholder="Your name (e.g. Mary)" value="Mary"/>
    <div class="row">
      <button id="createBtn" class="btn">Create Room</button>
      <button id="joinBtn" class="btn">Join Room</button>
    </div>
    <input id="roomInput" class="input" placeholder="Enter room code (e.g. 123456)"/>
    <div class="log" id="lobbyLog">No room yet.</div>
  </div>

  <div class="panel" id="gamePanel" style="display:none">
    <div class="center playerLabel">Room: <span id="roomCode"></span></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">
        <div class="small">You</div>
        <div id="youName" style="font-weight:800">Player</div>
        <div class="small" id="youStatus">Waiting...</div>
      </div>
      <div style="flex:1;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">
        <div class="small">Opponent</div>
        <div id="opName" style="font-weight:800">‚Äî</div>
        <div class="small" id="opStatus">‚Äî</div>
      </div>
    </div>

    <div class="log" id="gameLog">Waiting for both players...</div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="attackBtn" class="btn">Strike ‚öîÔ∏è</button>
      <button id="skillBtn" class="btn">Skill üèπ</button>
      <button id="trickBtn" class="btn">Trick ü™Ñ</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="leaveBtn" class="btn" style="background:#8b8b8b">Leave Room</button>
      <button id="restartBtn" class="btn" style="background:#6fb3ff">Restart Match</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/*
  IMPORTANT: After you create a Firebase project, copy the Web SDK config object
  from the Firebase console and paste it into the firebaseConfig variable below.
  Example (replace with your values):
  const firebaseConfig = {
    apiKey: "AIza...",
    authDomain: "your-project.firebaseapp.com",
    databaseURL: "https://your-project-default-rtdb.firebaseio.com",
    projectId: "your-project-id",
    storageBucket: "your-project-id.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcdef"
  };
*/
let firebaseConfig = {ig = {
  apiKey: "AIzaSyCFaVYLy37yGeKZ1Q90u2DkBI7K0TZ-6HE",
  authDomain: "marcus-f6747.firebaseapp.com",
  databaseURL: "https://marcus-f6747-default-rtdb.firebaseio.com",
  projectId: "marcus-f6747",
  storageBucket: "marcus-f6747.firebasestorage.app",
  messagingSenderId: "255400923033",
  appId: "1:255400923033:web:6ee961ef278ed7223e0d08",
  measurementId: "G-6SE70XDZSV"
}
  // <<--- PASTE YOUR FIREBASE CONFIG OBJECT HERE
};

// ----------------- Basic multiplayer logic using Realtime Database -----------------
// This is minimal code to get two players into a room and exchange moves.
// Security note: For quick testing you can set Realtime Database rules to allow reads/writes.
// See README.txt for exact rules and safer suggestions.
let app, db, auth;
let localPlayerId = null;
let roomRef = null;
let roomCodeGlobal = null;

function initFirebase() {
  if (!firebaseConfig || !firebaseConfig.apiKey) {
    document.getElementById('lobbyLog').textContent = 'Missing Firebase config ‚Äî paste it into index.html';
    return false;
  }
  app = firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  auth = firebase.auth();
  // anonymous auth (recommended)
  auth.signInAnonymously().catch(e=>console.warn(e));
  return true;
}

function genRoomCode(){ return Math.floor(100000 + Math.random()*900000).toString(); }

function createRoom(name){
  if(!initFirebase()) return;
  const code = genRoomCode();
  const path = 'rooms/' + code;
  const ref = db.ref(path);
  // room initial data
  const data = {
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    players: {
      p1: {name: name, ready: true, lastMove: null, score: 0},
    },
    round: 1,
    started: true
  };
  ref.set(data, (err)=>{
    if(err){ document.getElementById('lobbyLog').textContent = 'Failed to create room: '+err; return; }
    joinRoom(code, name, true);
  });
}

function joinRoom(code, name, isCreator=false){
  if(!initFirebase()) return;
  const path = 'rooms/' + code;
  const ref = db.ref(path);
  ref.once('value', snap=>{
    if(!snap.exists()){ document.getElementById('lobbyLog').textContent = 'Room not found.'; return; }
    const room = snap.val();
    // find empty slot p1 or p2
    let updates = {};
    if(!room.players || !room.players.p1){
      updates['players/p1'] = {name:name, ready:true, lastMove:null, score:0};
    } else if(!room.players.p2){
      updates['players/p2'] = {name:name, ready:true, lastMove:null, score:0};
    } else {
      document.getElementById('lobbyLog').textContent = 'Room full.'; return;
    }
    ref.update(updates, ()=>{
      document.getElementById('lobbyLog').textContent = 'Joined room ' + code;
      setupRoomListeners(code, name, isCreator);
    });
  });
}

function setupRoomListeners(code, name, isCreator=false){
  roomCodeGlobal = code;
  roomRef = db.ref('rooms/' + code);
  localPlayerId = null;
  roomRef.on('value', snap=>{
    const room = snap.val();
    if(!room) return;
    // determine player slots and names
    const p1 = room.players && room.players.p1 ? room.players.p1.name : null;
    const p2 = room.players && room.players.p2 ? room.players.p2.name : null;
    // set UI
    const youName = (p1 === name) ? 'You ('+p1+')' : (p2 === name ? 'You ('+p2+')' : 'You');
    document.getElementById('youName').textContent = youName;
    document.getElementById('opName').textContent = (p1 && p2) ? (p1===name? p2 : p1) : 'Waiting...';
    document.getElementById('roomCode').textContent = code;
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('gamePanel').style.display = 'block';
    updateGameLog(room, name);
  });
}

function updateGameLog(room, name){
  const p1 = room.players && room.players.p1 ? room.players.p1 : null;
  const p2 = room.players && room.players.p2 ? room.players.p2 : null;
  let status = '';
  status += 'Round: ' + (room.round || 1) + ' | ';
  status += 'Players: ' + (p1? p1.name:'-') + (p2? ' vs ' + p2.name : ' (waiting)') + '\n\n';
  // show last moves if available
  if(p1 && p2){
    const last1 = p1.lastMove ? p1.lastMove : '‚Äî';
    const last2 = p2.lastMove ? p2.lastMove : '‚Äî';
    status += p1.name + ' last move: ' + last1 + '\n' + p2.name + ' last move: ' + last2 + '\n\n';
    // simple round resolution example: compare lastMove values when both exist
    if(p1.lastMove && p2.lastMove){
      const result = resolveMoves(p1.lastMove, p2.lastMove);
      status += 'Round result: ' + result + '\n';
    } else {
      status += 'Waiting for moves...' + '\n';
    }
  } else {
    status += 'Waiting for opponent to join...';
  }
  document.getElementById('gameLog').textContent = status;
}

function resolveMoves(m1, m2){
  // Reuse simple deterministic resolution: higher numeric value wins;
  // mapping: strike=3, skill=2, trick=4 (trick auto-wins unless special case)
  const val = {strike:3, skill:2, trick:4};
  if(m1 === m2) return 'Draw';
  if(m1==='trick' && m2!=='trick') return 'Player1 (trick) auto-wins';
  if(m2==='trick' && m1!=='trick') return 'Player2 (trick) auto-wins';
  return val[m1] > val[m2] ? 'Player1 wins' : 'Player2 wins';
}

// player actions
function sendMove(move){
  if(!roomRef) return;
  // read room once to decide whether this player is p1 or p2
  roomRef.once('value', snap=>{
    const room = snap.val();
    if(!room) return;
    let slot = null;
    if(room.players && room.players.p1 && room.players.p1.name === document.getElementById('nameInput').value){
      slot = 'p1';
    } else if(room.players && room.players.p2 && room.players.p2.name === document.getElementById('nameInput').value){
      slot = 'p2';
    } else {
      // fallback: choose empty or p2
      slot = room.players && !room.players.p2 ? 'p2' : 'p1';
    }
    const updates = {};
    updates['players/' + slot + '/lastMove'] = move;
    roomRef.update(updates);
  });
}

// UI wiring
document.getElementById('createBtn').addEventListener('click', ()=>{
  const name = document.getElementById('nameInput').value.trim() || 'Player';
  createRoom(name);
});
document.getElementById('joinBtn').addEventListener('click', ()=>{
  const code = document.getElementById('roomInput').value.trim();
  const name = document.getElementById('nameInput').value.trim() || 'Player';
  if(!code){ document.getElementById('lobbyLog').textContent = 'Enter a room code to join.'; return; }
  joinRoom(code, name);
});
document.getElementById('attackBtn').addEventListener('click', ()=>sendMove('strike'));
document.getElementById('skillBtn').addEventListener('click', ()=>sendMove('skill'));
document.getElementById('trickBtn').addEventListener('click', ()=>sendMove('trick'));
document.getElementById('leaveBtn').addEventListener('click', ()=>{
  if(roomRef) roomRef.off();
  document.getElementById('gamePanel').style.display='none';
  document.getElementById('lobby').style.display='block';
  document.getElementById('lobbyLog').textContent='Left room.';
});
document.getElementById('restartBtn').addEventListener('click', ()=>{
  if(!roomRef) return;
  roomRef.update({round:1, 'players/p1/lastMove':null, 'players/p2/lastMove':null, 'players/p1/score':0, 'players/p2/score':0});
});

// Expose init function to allow manual init after pasting config
window.initFirebaseWeb = initFirebase;

</script>

</body>
</html>
